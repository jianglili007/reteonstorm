#!/bin/bash

BUILD_LOG=${ROS_LOGS}/mvn_build_log

if [ "$1" == "-c" ]; then
    cd $RETEONSTORM
    echo "Compiling..."
    if mvn clean install > $BUILD_LOG ; then
        echo "mvn build success"
    else
        cat $BUILD_LOG
        exit
    fi
elif [ "$1" == "-c!" ]; then
    echo "reusing previously build jar"
else
    echo "Missing argument: Re-run using either -c or -c! "
    exit
fi
    
more=false

# input-size dependent arrays
SIZE=( 50000 )
TIME=( 165 )

if $more ; then
    i=1
    for s in `seq 1 1`;do # append values for indexes 1..x
        SIZE[$i]=`expr $s \* 10000`
        TIME[$i]=10 # `echo "($s+0)*30" | bc`
        (( i++ ))
    done
fi

# input-size independent arrays
FILTER=( ?a_foo_0 )
NODES=( 2 )
TPAR=( 2 )
FPAR=( 1 )
SPAR=( 2 )
SHARE=( true )

for (( i=0; i<${#SIZE[@]}; i++ ));do
 for nodes in ${NODES[@]};do
  for tpar in ${TPAR[@]};do
   for fpar in ${FPAR[@]};do
    for spar in ${SPAR[@]};do
     for filter in ${FILTER[@]};do
      for share in ${SHARE[@]};do

                        # if [ $tpar -eq 1 ] && [ $fpar -eq 2 ]; then continue; fi

                            date
            
                            # this iteration is a single measurement
                            # each measurement runs reteonstorm a few times and produces a single summary file
                            # each "different" measurement should be given a different id (-mid)
                            # giving the same -mid would overwrite the previous logs and log-summary
        
                            ${ROS_SCRIPTS}/measure \
                                -n $nodes \
                                -ns $share \
                                -F $filter \
                                -sp $spar \
                                -fp $fpar \
                                -tp $tpar \
                                -i ${SIZE[$i]} \
                                -ttl ${TIME[$i]} \
                                -mid "nodes${nodes}_share${share}_filter${filter}_spar${spar}_fpar${fpar}_tpar${tpar}_size${SIZE[$i]}"
                        done
                    done
                done
            done
        done
    done
done
echo "experiment done."
